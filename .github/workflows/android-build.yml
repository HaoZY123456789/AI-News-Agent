name: ðŸ¤– AIèµ„è®¯æ™ºèƒ½ä½“ Android APK æž„å»º

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.py'
      - 'buildozer.spec'
      - 'config.ini'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: â˜• è®¾ç½® Java çŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          zip \
          unzip
          
    - name: ðŸ“± å®‰è£… Android æž„å»ºå·¥å…·
      run: |
        pip install --upgrade pip
        pip install buildozer cython
        pip install -r requirements_android.txt
        
    - name: ðŸ—ï¸ æž„å»º APK
      run: |
        export JAVA_HOME=$JAVA_HOME
        cp buildozer-github.spec buildozer.spec
        buildozer android debug
        
    - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºä¿¡æ¯
      run: |
        echo "ðŸŽ‰ APK æž„å»ºå®Œæˆï¼"
        ls -la bin/
        
    - name: ðŸ“¤ ä¸Šä¼  APK æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ai-news-agent-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "## ðŸ¤– AIèµ„è®¯æ™ºèƒ½ä½“ APK æž„å»ºæŠ¥å‘Š" > build-report.md
        echo "" >> build-report.md
        echo "**æž„å»ºæ—¶é—´:** $(date)" >> build-report.md
        echo "**æž„å»ºçŠ¶æ€:** âœ… æˆåŠŸ" >> build-report.md
        echo "**APKæ–‡ä»¶:**" >> build-report.md
        echo "\`\`\`" >> build-report.md
        ls -la bin/*.apk >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "### ðŸ“± å®‰è£…è¯´æ˜Ž" >> build-report.md
        echo "1. ä¸‹è½½ä¸Šæ–¹çš„ APK æ–‡ä»¶" >> build-report.md
        echo "2. åœ¨Androidè®¾å¤‡ä¸Šå¼€å¯"æœªçŸ¥æ¥æº"å®‰è£…æƒé™" >> build-report.md
        echo "3. ç‚¹å‡»APKæ–‡ä»¶å®Œæˆå®‰è£…" >> build-report.md
        echo "4. é¦–æ¬¡è¿è¡Œæ—¶é…ç½®é‚®ç®±ä¿¡æ¯" >> build-report.md
        echo "5. äº«å—AIèµ„è®¯æ™ºèƒ½ä½“ï¼ðŸŽŠ" >> build-report.md
        
    - name: ðŸ“‹ ä¸Šä¼ æž„å»ºæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md